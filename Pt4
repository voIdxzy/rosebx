-- VSTAR FINAL (full) -------------------------------------------------------
local lib = loadstring(game:HttpGet("https://raw.githubusercontent.com/Just3itx/3itx-UI-LIB/refs/heads/main/Lib"))()
local FlagsManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/Just3itx/3itx-UI-LIB/refs/heads/main/ConfigManager"))()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInput = game:GetService("UserInputService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Lighting = game:GetService("Lighting")
local CoreGui = game:GetService("CoreGui")
local GuiService = game:GetService("GuiService")

local LocalPlayer = Players.LocalPlayer

local main = lib:Load({
    Title = 'VSTAR',
    ToggleButton = "RBXID or GetCustomasset",
    BindGui = Enum.KeyCode.RightControl,
})

local TabMain = main:AddTab("MAIN")
main:SelectTab()

-- ANTI AFK -----------------------------------------------------------------
local SecAntiAFK = TabMain:AddSection({Title = "Anti AFK"})
local antiAFKConnection
SecAntiAFK:AddToggle("AntiAFKToggle", {
    Title = "Anti AFK",
    Default = false,
    Callback = function(state)
        if state then
            if not antiAFKConnection then
                antiAFKConnection = LocalPlayer.Idled:Connect(function()
                    local vu = game:GetService("VirtualUser")
                    vu:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
                    task.wait(1)
                    vu:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
                end)
            end
            lib:Notification("VSTAR", "Anti AFK Enabled!", 2)
        else
            if antiAFKConnection then
                antiAFKConnection:Disconnect()
                antiAFKConnection = nil
            end
            lib:Notification("VSTAR", "Anti AFK Disabled!", 2)
        end
    end
})

-- PLAYER TAB ---------------------------------------------------------------
local TabPlayer = main:AddTab("PLAYER")

-- Movement Section
local SecMovement = TabPlayer:AddSection({ Title = "Movement" })
local wsToggle, wsValue = false, 16
SecMovement:AddToggle("WalkSpeedToggle", { Title = "Walk Speed", Default = false, Callback = function(v) wsToggle = v end })
SecMovement:AddSlider("WalkSpeedValue", { Title = "Walk Speed Value", Min = 0, Max = 200, Default = 16, Callback = function(val) wsValue = val end })
RunService.Stepped:Connect(function()
    local char = LocalPlayer.Character
    if wsToggle and char and char:FindFirstChildOfClass("Humanoid") then
        char:FindFirstChildOfClass("Humanoid").WalkSpeed = wsValue
    end
end)

local hjToggle, hjValue = false, 50
SecMovement:AddToggle("HighJumpToggle", { Title = "High Jump", Default = false, Callback = function(v) hjToggle = v end })
SecMovement:AddSlider("HighJumpValue", { Title = "High Jump Power", Min = 0, Max = 300, Default = 50, Callback = function(val) hjValue = val end })
RunService.Stepped:Connect(function()
    local char = LocalPlayer.Character
    if hjToggle and char and char:FindFirstChildOfClass("Humanoid") then
        char:FindFirstChildOfClass("Humanoid").JumpPower = hjValue
    end
end)

local infJump = false
SecMovement:AddToggle("InfiniteJump", { Title = "Infinite Jump", Default = false, Callback = function(v) infJump = v end })
UserInput.JumpRequest:Connect(function()
    local char = LocalPlayer.Character
    if infJump and char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum:ChangeState(Enum.HumanoidStateType.Jumping) end
    end
end)

-- Mode Section
local SecMode = TabPlayer:AddSection({ Title = "Mode" })
local noclip = false
SecMode:AddToggle("NoClip", { Title = "No Clip", Default = false, Callback = function(v) noclip = v end })
RunService.Stepped:Connect(function()
    if noclip then
        local char = LocalPlayer.Character
        if char then
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") and part.CanCollide then
                    part.CanCollide = false
                end
            end
        end
    end
end)

SecMode:AddToggle("NoFallDamage", {
    Title = "No Fall Damage",
    Default = false,
    Callback = function(v)
        local char = LocalPlayer.Character
        if v and char and char:FindFirstChildOfClass("Humanoid") then
            char:FindFirstChildOfClass("Humanoid").StateChanged:Connect(function(_, new)
                if new == Enum.HumanoidStateType.Freefall then
                    char:FindFirstChildOfClass("Humanoid"):ChangeState(Enum.HumanoidStateType.Seated)
                end
            end)
        end
    end
})

SecMode:AddToggle("Godmode", {
    Title = "Godmode",
    Default = false,
    Callback = function(v)
        local char = LocalPlayer.Character
        if v and char and char:FindFirstChildOfClass("Humanoid") then
            local hum = char:FindFirstChildOfClass("Humanoid")
            hum.MaxHealth = math.huge
            hum.Health = math.huge
        end
    end
})

-- FLY (support keyboard + mobile joystick + gamepad) -----------------------
local flyEnabled = false
local flyMaxSpeed = 50
local flyCurrentSpeed = 0
local flyLastDir = Vector3.zero
local flyBG, flyBV
local flyConn
local animateWasDisabled = false

local function getFlyBodyPart()
    local char = LocalPlayer.Character
    if not char then return nil end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if hum and hum.RigType == Enum.HumanoidRigType.R6 then
        return char:FindFirstChild("Torso")
    else
        return char:FindFirstChild("UpperTorso") or char:FindFirstChild("HumanoidRootPart")
    end
end

local function cleanupFlyParts()
    if flyBG then pcall(function() flyBG:Destroy() end) flyBG = nil end
    if flyBV then pcall(function() flyBV:Destroy() end) flyBV = nil end
end

local function restoreAnimate(char)
    if not char then return end
    local animate = char:FindFirstChild("Animate")
    if animate and animateWasDisabled then
        animate.Disabled = false
        animateWasDisabled = false
    end
end

local function stopFly()
    flyEnabled = false
    if flyConn then flyConn:Disconnect() flyConn = nil end
    local char = LocalPlayer.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            pcall(function() hum.PlatformStand = false end)
        end
        cleanupFlyParts()
        restoreAnimate(char)
    end
    flyCurrentSpeed = 0
    flyLastDir = Vector3.zero
    lib:Notification("VSTAR", "Fly OFF", 2)
end

local function disableHumanoidStates(hum)
    if not hum then return end
    local states = {
        Enum.HumanoidStateType.Climbing,
        Enum.HumanoidStateType.FallingDown,
        Enum.HumanoidStateType.Flying,
        Enum.HumanoidStateType.Freefall,
        Enum.HumanoidStateType.GettingUp,
        Enum.HumanoidStateType.Jumping,
        Enum.HumanoidStateType.Landed,
        Enum.HumanoidStateType.Physics,
        Enum.HumanoidStateType.PlatformStanding,
        Enum.HumanoidStateType.Ragdoll,
        Enum.HumanoidStateType.Running,
        Enum.HumanoidStateType.RunningNoPhysics,
        Enum.HumanoidStateType.Seated,
        Enum.HumanoidStateType.StrafingNoPhysics,
        Enum.HumanoidStateType.Swimming,
    }
    for _, s in ipairs(states) do
        pcall(function() hum:SetStateEnabled(s, false) end)
    end
end

local function enableHumanoidStates(hum)
    if not hum then return end
    local states = {
        Enum.HumanoidStateType.Climbing,
        Enum.HumanoidStateType.FallingDown,
        Enum.HumanoidStateType.Flying,
        Enum.HumanoidStateType.Freefall,
        Enum.HumanoidStateType.GettingUp,
        Enum.HumanoidStateType.Jumping,
        Enum.HumanoidStateType.Landed,
        Enum.HumanoidStateType.Physics,
        Enum.HumanoidStateType.PlatformStanding,
        Enum.HumanoidStateType.Ragdoll,
        Enum.HumanoidStateType.Running,
        Enum.HumanoidStateType.RunningNoPhysics,
        Enum.HumanoidStateType.Seated,
        Enum.HumanoidStateType.StrafingNoPhysics,
        Enum.HumanoidStateType.Swimming,
    }
    for _, s in ipairs(states) do
        pcall(function() hum:SetStateEnabled(s, true) end)
    end
end

local function startFly()
    local char = LocalPlayer.Character
    if not char then lib:Notification("VSTAR", "Karakter belum siap", 2) return end
    local body = getFlyBodyPart()
    if not body then lib:Notification("VSTAR", "Body part untuk fly tidak ditemukan", 3) return end

    local hum = char:FindFirstChildOfClass("Humanoid")
    if hum then
        pcall(function() hum.PlatformStand = true end)
        disableHumanoidStates(hum)
    end

    -- disable Animate
    local animate = char:FindFirstChild("Animate")
    if animate and not animate.Disabled then
        animate.Disabled = true
        animateWasDisabled = true
    end

    -- create movers
    flyBG = Instance.new("BodyGyro")
    flyBG.P = 9e4
    flyBG.MaxTorque = Vector3.new(9e9,9e9,9e9)
    flyBG.CFrame = body.CFrame
    flyBG.Parent = body

    flyBV = Instance.new("BodyVelocity")
    flyBV.Velocity = Vector3.new(0, 0.1, 0)
    flyBV.MaxForce = Vector3.new(9e9,9e9,9e9)
    flyBV.Parent = body

    flyEnabled = true
    flyCurrentSpeed = 0
    flyLastDir = Vector3.zero

    -- main fly loop (MoveDirection-based so supports joystick/mobile)
    flyConn = RunService.RenderStepped:Connect(function()
        if not flyEnabled or not LocalPlayer.Character then return end
        local cam = workspace.CurrentCamera
        if not cam then return end
        local humLocal = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if not humLocal then return end

        -- get direction from humanoid MoveDirection (supports keyboard + mobile thumbstick + gamepad)
        local md = humLocal.MoveDirection
        local moveDir = Vector3.new(md.X, 0, md.Z)

        local moving = moveDir.Magnitude > 0.01
        if moving then
            flyCurrentSpeed = flyCurrentSpeed + 0.5 + (flyCurrentSpeed / (flyMaxSpeed == 0 and 1 or flyMaxSpeed))
            if flyCurrentSpeed > flyMaxSpeed then flyCurrentSpeed = flyMaxSpeed end
            flyLastDir = moveDir
        elseif flyCurrentSpeed > 0 then
            flyCurrentSpeed = flyCurrentSpeed - 1
            if flyCurrentSpeed < 0 then flyCurrentSpeed = 0 end
        end

        if moving or flyCurrentSpeed > 0 then
            local dir = (moving and moveDir or flyLastDir)
            local worldVel = cam.CFrame:VectorToWorldSpace(dir.Unit) * flyCurrentSpeed
            flyBV.Velocity = worldVel
        else
            flyBV.Velocity = Vector3.zero
        end

        -- tilt & orientation similar to original
        local tilt = 0
        if moveDir.Magnitude > 0 then
            tilt = (moveDir.Z) * 50 * (flyCurrentSpeed / (flyMaxSpeed == 0 and 1 or flyMaxSpeed))
        end
        flyBG.CFrame = cam.CFrame * CFrame.Angles(-math.rad(tilt), 0, 0)
    end)

    lib:Notification("VSTAR", "Fly ON", 2)
end

SecMode:AddToggle("FlyToggle", {
    Title = "Fly",
    Default = false,
    Callback = function(state)
        if state then
            startFly()
        else
            stopFly()
        end
    end
})
SecMode:AddSlider("FlySpeed", {
    Title = "Fly Speed",
    Min = 5, Max = 250, Default = flyMaxSpeed,
    Callback = function(v)
        flyMaxSpeed = tonumber(v) or flyMaxSpeed
    end
})

-- ensure cleanup and re-apply on respawn if toggle still true
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.5)
    if lib.Flags and lib.Flags["FlyToggle"] and lib.Flags["FlyToggle"].Value then
        -- restart fly after respawn
        stopFly()
        task.wait(0.2)
        startFly()
    else
        -- just cleanup leftovers
        stopFly()
    end
end)

-- MISC TAB: Teleport, ESP, etc. ---------------------------------------------
local TabMisc = main:AddTab("MISC")
local SecTeleport = TabMisc:AddSection({ Title = "Teleport" })
local selectedPlayer = nil
local playerList = {}

local function buildPlayerList()
    table.clear(playerList)
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            table.insert(playerList, p.Name)
        end
    end
    -- update dropdown options if available
    if lib.Flags and lib.Flags["SelectTeleportPlayer"] and lib.Flags["SelectTeleportPlayer"].SetOptions then
        pcall(function() lib.Flags["SelectTeleportPlayer"]:SetOptions(playerList) end)
    end
end
buildPlayerList()
Players.PlayerAdded:Connect(buildPlayerList)
Players.PlayerRemoving:Connect(buildPlayerList)

SecTeleport:AddDropdown("SelectTeleportPlayer", {
    Title = "Select Player",
    Options = playerList,
    Callback = function(name) selectedPlayer = name end
})
SecTeleport:AddButton({
    Title = "Refresh Player List",
    Callback = function()
        buildPlayerList()
        lib:Notification("VSTAR", "Player list refreshed!", 2)
    end
})
SecTeleport:AddButton({
    Title = "Teleport to Player",
    Callback = function()
        if not selectedPlayer then
            lib:Notification("VSTAR", "No player selected!", 2)
            return
        end
        local target = Players:FindFirstChild(selectedPlayer)
        if not (target and target.Character and target.Character:FindFirstChild("HumanoidRootPart")) then
            lib:Notification("VSTAR", "Player not found!", 2)
            return
        end
        local hrp = target.Character:FindFirstChild("HumanoidRootPart")
        if hrp and LocalPlayer.Character then
            LocalPlayer.Character:PivotTo(hrp.CFrame)
            lib:Notification("VSTAR", "Teleported to "..selectedPlayer, 2)
        else
            lib:Notification("VSTAR", "Target not available!", 2)
        end
    end
})

local SecOther = TabMisc:AddSection({ Title = "Other" })
SecOther:AddToggle("ChatSpy", {
    Title = "Chat Spy",
    Default = false,
    Callback = function(state)
        if state then
            for _, p in ipairs(Players:GetPlayers()) do
                p.Chatted:Connect(function(msg)
                    print("[CHAT SPY] " .. p.Name .. ": " .. msg)
                end)
            end
            lib:Notification("VSTAR", "Chat Spy ON", 3)
        else
            lib:Notification("VSTAR", "Chat Spy OFF", 3)
        end
    end
})

-- ESP functions
local function createESP(player)
    if player == LocalPlayer then return end
    if player.Character and not player.Character:FindFirstChild("VSTAR_ESP") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "VSTAR_ESP"
        highlight.Adornee = player.Character
        highlight.FillColor = Color3.fromRGB(255, 0, 0)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.Parent = player.Character
    end
end
local function removeESP(player)
    if player.Character and player.Character:FindFirstChild("VSTAR_ESP") then
        player.Character.VSTAR_ESP:Destroy()
    end
end

SecOther:AddToggle("ESP", {
    Title = "ESP",
    Default = false,
    Callback = function(state)
        for _, p in ipairs(Players:GetPlayers()) do
            if state then createESP(p) else removeESP(p) end
        end
        if state then
            Players.PlayerAdded:Connect(createESP)
            Players.PlayerRemoving:Connect(removeESP)
        end
    end
})

-- Full Bright
local normalBrightness = Lighting.Brightness
local normalClockTime = Lighting.ClockTime
local normalFogEnd = Lighting.FogEnd
local normalAmbient = Lighting.Ambient
SecOther:AddToggle("FullBright", {
    Title = "Full Bright",
    Default = false,
    Callback = function(state)
        if state then
            Lighting.Brightness = 2
            Lighting.ClockTime = 14
            Lighting.FogEnd = 100000
            Lighting.Ambient = Color3.fromRGB(255, 255, 255)
        else
            Lighting.Brightness = normalBrightness
            Lighting.ClockTime = normalClockTime
            Lighting.FogEnd = normalFogEnd
            Lighting.Ambient = normalAmbient
        end
    end
})

-- SERVER TAB ---------------------------------------------------------------
local TabServer = main:AddTab("SERVER")
local SecServerControl = TabServer:AddSection({Title = "Server Control"})

-- Robust Auto Reconnect / Auto Rejoin -------------------------------------
local autoReconnectEnabled = false
local rejoinThread = nil
local reconnectConns = {}

local function startRejoinLoop()
    if rejoinThread then return end
    rejoinThread = task.spawn(function()
        local delaySec = 6
        while autoReconnectEnabled do
            pcall(function() TeleportService:Teleport(game.PlaceId, LocalPlayer) end)
            task.wait(delaySec)
        end
        rejoinThread = nil
    end)
end

local function stopRejoinLoop()
    autoReconnectEnabled = false
    rejoinThread = nil
end

local function clearReconnectConns()
    for _, c in ipairs(reconnectConns) do pcall(function() c:Disconnect() end) end
    table.clear(reconnectConns)
end

local function connectReconnectSignals()
    clearReconnectConns()
    table.insert(reconnectConns, TeleportService.TeleportInitFailed:Connect(function(player, result, msg)
        if autoReconnectEnabled and player == LocalPlayer then startRejoinLoop() end
    end))
    table.insert(reconnectConns, LocalPlayer.OnTeleport:Connect(function(state)
        if autoReconnectEnabled and state == Enum.TeleportState.Failed then startRejoinLoop() end
    end))
    table.insert(reconnectConns, CoreGui.DescendantAdded:Connect(function(obj)
        if not autoReconnectEnabled then return end
        if obj.Name == "ErrorPrompt" then startRejoinLoop() end
    end))
    table.insert(reconnectConns, GuiService.ErrorMessageChanged:Connect(function(msg)
        if autoReconnectEnabled and msg and #msg > 0 then startRejoinLoop() end
    end))
end

local function disableAutoReconnect()
    stopRejoinLoop()
    clearReconnectConns()
end

SecServerControl:AddToggle("AutoReconnect", {
    Title = "Auto Reconnect",
    Default = false,
    Callback = function(v)
        autoReconnectEnabled = v
        if v then
            connectReconnectSignals()
            lib:Notification("VSTAR", "Auto Reconnect ON", 2)
        else
            disableAutoReconnect()
            lib:Notification("VSTAR", "Auto Reconnect OFF", 2)
        end
    end
})

SecServerControl:AddButton({
    Title = "Rejoin",
    Callback = function()
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
    end
})

SecServerControl:AddButton({
    Title = "Hop Server",
    Callback = function()
        local ok, res = pcall(function()
            return HttpService:JSONDecode(game:HttpGet(("https://games.roblox.com/v1/games/%s/servers/Public?sortOrder=Asc&limit=100"):format(game.PlaceId)))
        end)
        if not ok or not res or not res.data then
            lib:Notification("VSTAR", "Gagal ambil daftar server", 3)
            return
        end
        for _, srv in ipairs(res.data) do
            if srv.id ~= game.JobId and srv.playing < srv.maxPlayers then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, srv.id, LocalPlayer)
                return
            end
        end
        lib:Notification("VSTAR", "Tidak ada server tersedia", 3)
    end
})

SecServerControl:AddButton({
    Title = "Copy Server ID",
    Callback = function()
        if setclipboard then
            setclipboard(game.JobId)
            lib:Notification("VSTAR", "Server ID copied!", 2)
        else
            lib:Notification("VSTAR", "setclipboard tidak tersedia", 2)
        end
    end
})

SecServerControl:AddTextbox({
    Title = "Join via Server ID",
    Default = "",
    PlaceHolder = "Masukkan JobId",
    TextDisappear = false,
    Callback = function(id)
        if typeof(id) == "string" and #id > 0 then
            TeleportService:TeleportToPlaceInstance(game.PlaceId, id, LocalPlayer)
        else
            lib:Notification("VSTAR", "JobId tidak valid", 2)
        end
    end
})

-- CONFIG TAB ---------------------------------------------------------------
local TabConfig = main:AddTab("CONFIG")
FlagsManager:SetLibrary(lib)
FlagsManager:SetIgnoreIndexes({})
FlagsManager:SetFolder("Config/VSTAR")
FlagsManager:InitSaveSystem(TabConfig)

lib:Notification('VSTAR', 'Thanks for using VSTAR!', 3)
-- End of VSTAR FINAL -------------------------------------------------------
